<!DOCTYPE html>

<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/duotone.css" integrity="sha384-R3QzTxyukP03CMqKFe0ssp5wUvBPEyy9ZspCB+Y01fEjhMwcXixTyeot+S40+AjZ" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/fontawesome.css" integrity="sha384-eHoocPgXsiuZh+Yy6+7DsKAerLXyJmu2Hadh4QYyt+8v86geixVYwFqUvMU8X90l" crossorigin="anonymous"/>
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <title>Calc</title>
    <h1 align="center">Calc</h1>

  </head>

  <body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <!-- Navbar Brand-->
        <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" fill="currentColor" class="bi bi-egg" viewBox="0 0 16 16">
          <path d="M8 15a5 5 0 0 1-5-5c0-1.956.69-4.286 1.742-6.12.524-.913 1.112-1.658 1.704-2.164C7.044 1.206 7.572 1 8 1c.428 0 .956.206 1.554.716.592.506 1.18 1.251 1.704 2.164C12.31 5.714 13 8.044 13 10a5 5 0 0 1-5 5zm0 1a6 6 0 0 0 6-6c0-4.314-3-10-6-10S2 5.686 2 10a6 6 0 0 0 6 6z"/>
        </svg>
        <a class="navbar-brand ps-3" href="">JoEyes</a>
        <!-- Sidebar Toggle-->

        <!-- Navbar Search-->
        <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">

        </form>
        <!-- Navbar-->
        <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">

        </ul>
    </nav>
    <div id="layoutSidenav">
        <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                <div class="sb-sidenav-menu">
                    <div class="nav">

                        <div class="nav-link">
                          <form id="tickerForm">

                            <label for="ticker">Ticker:</label>
                            <input type="text" id="tickerInput" name="ticker"><div id="underlying" style="display:none"></div><br>



                            <div class="form-check form-switch">

                              <label class="form-check-label" id="switchlabel" for="flexSwitchCheckChecked">Call</label>
                              <input class="form-check-input" name="CP"  value="call" type="radio" id="flexSwitchCheckChecked" checked>
                            </div>



                            <div class="putt form-check form-switch">
                              <input class="form-check-input"  name="CP" value="put" type="radio" id="flexSwitchCheckDefault">
                              <label class="form-check-label"  for="flexSwitchCheckDefault">Put</label>
                            </div>








                          <!-- <input type="radio" name="CP" value="call">call <input type="radio" name="CP" value="put">put<br> -->
                            <label class="targlabel" for="targ">Target:</label>
                            <input type="text" id="targ" name="targ"><br>


                            <div class="row">
                            <div id="dates" class="column" style="display:none">
                              <label for="dates">Dates:</label><br>
                            </div>

                          </div>

                            <div id="dates1" class="row" style="display:none">
                               <label for="dates">Dates:</label><br>

                            </div>

                          </form>

                        </div>

                        <button type="button" class="btn btn-outline-success" id="myBTN" onclick="submit()">Search</button>
                        <div class="row">


                    </div>
                </div>

            </nav>
        </div>
        <div id="layoutSidenav_content">


                <div class="container-fluid px-4">
                  <div id="contracts1" class="row" style="display: none">
                    <label for="contracts">CONTRACTS</label><br />
                  </div>
                  <div id="contracts" class="column" style="display: none">
                    <label for="contracts">CONTRACTS</label><br />
                  </div>






        </div>
    </div>


    <script>
      document
        .getElementById("tickerInput")
        .addEventListener("keyup", function (event) {
          if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("myBTN").click();
          }
        });

      var tForm = document.getElementById("tickerForm");
      var ticker = tForm.elements[0].value.toUpperCase();
      var underlyingPrice = 0;

      async function getDates() {
        const api_url =
          "https://api.tdameritrade.com/v1/marketdata/chains?apikey=4WGUBOZHWUSYEMPL9NPVT9QM7GJO1TDQ&symbol=" +
          ticker +
          "&strikeCount=1&fromDate=2019-08-10&toDate=2023-8-30";
        const response = await fetch(api_url);
        const data = await response.json();
        underlyingPrice = data["underlyingPrice"];
        var addDatesCode = "";
        for (var key in data["callExpDateMap"]) {
          var tempDate = key.substring(0, key.indexOf(":"));
          addDatesCode +=
            '<input type="radio" name="dateRB" value="' +
            key +
            '">' +
            tempDate +
            "<br>";
        }
        document.getElementById("dates").innerHTML += addDatesCode;
        document.getElementById("underlying").innerHTML +=
          "Underlying Price: " + underlyingPrice.toFixed(2);
        document.getElementById("underlying").style.display = "block";
      }

      async function getContracts(cp, date) {
        const api_url =
          "https://api.tdameritrade.com/v1/marketdata/chains?apikey=4WGUBOZHWUSYEMPL9NPVT9QM7GJO1TDQ&symbol=" +
          ticker +
          "&strikeCount=120&fromDate= " +
          date.substring(0, date.indexOf(":")) +
          "&toDate=" +
          date.substring(0, date.indexOf(":")) +
          "&contractType=" +
          cp;
        const response = await fetch(api_url);
        const contractsData = await response.json();

        if (cp == "CALL") {
          addContracts(contractsData["callExpDateMap"][date], cp);
        } else {
          addContracts(contractsData["putExpDateMap"][date], cp);
        }
      }

      var changed = false;
      var phase = 0;
      var checkedCP = "";
      function submit() {
        var x = document.getElementById("dates");
        if (x.style.display == "none") {
          x.style.display = "block";
        }

        if (ticker != tForm.elements[0].value.toUpperCase()) {
          changed = true;
          ticker = tForm.elements[0].value.toUpperCase();
        } else {
          changed = false;
        }

        if (changed == true) {
          phase = 0;
          document.getElementById("dates").innerHTML =
            '<label for="dates">Dates:</label><br>';
          document.getElementById("contracts").innerHTML =
            '<label for="contracts">CONTRACTS</label><br>';
          document.getElementById("underlying").innerHTML = "";
          getDates();
        }

        var CPradios = document.getElementsByName("CP");
        var datesRadios = document.getElementsByName("dateRB");

        for (var i = 0, length = CPradios.length; i < length; i++) {
          if (CPradios[i].checked) {
            checkedCP = CPradios[i].value;
            break;
          }
        }

        for (var i = 0, length = datesRadios.length; i < length; i++) {
          if (datesRadios[i].checked) {
            if (checkedCP == "call") {
              getContracts("CALL", datesRadios[i].value);
            } else {
              getContracts("PUT", datesRadios[i].value);
            }
            break;
          }
        }
      }

      function percIncrease(a, b) {
        let percent;
        if (b !== 0) {
          if (a !== 0) {
            percent = ((b - a) / a) * 100;
          } else {
            percent = b * 100;
          }
        } else {
          percent = -a * 100;
        }
        return Math.floor(percent);
      }

      function addContracts(data, cp) {
        document.getElementById("contracts").style.display = "block";
        var targ = tForm.elements[3].value;
        var addContractsCode = "";
        for (var item in data) {
          for (var item1 in data[item][0]) {
            if (item1 == "bid") {
              var bid = data[item][0][item1];
            }
            if (item1 == "ask") {
              var ask = data[item][0][item1];
            }
            if (item1 == "strikePrice") {
              var strike = data[item][0][item1];
            }
          }
          var mid = (bid + ask) / 2;
          if (targ > strike) {
            var percentGain = percIncrease(mid, targ - strike);
            if (percentGain<100){
              continue;
            }
            if (cp == "CALL") {
              addContractsCode +=
                "<label>" +
                strike +
                "c </label>   " +
                bid +
                "   " +
                ask +
                "   Return: " +
                percentGain +
                "% <br>";
            } else {
              addContractsCode +=
                "<label>Strike: " +
                strike +
                "p </label>" +
                "<br>" +
                "Bid: " +
                bid +
                "<br>" +
                "Ask: " +
                ask +
                "<br>Return: " +
                percentGain +
                "% <br>";
            }
          } else {
            //percentGain = percIncrease(mid, strike-targ);
          }
        }
        document.getElementById("contracts").innerHTML += addContractsCode;
        phase = 1;
      }

      function datesPhase() {}
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>

  </body>
</html>
